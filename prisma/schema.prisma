// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Person {
  id          String   @id @default(cuid())
  name        String
  email       String?  @unique
  phone       String?
  tags        Json?
  customFields Json?
  ownerUserId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  organizations     PersonOrganization[]
  fromRelationships Relationship[] @relation("FromRelationships")
  toRelationships   Relationship[] @relation("ToRelationships")
  pipelineItems     PipelineItem[]
  tasks             Task[]

  @@map("people")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  type      String?
  region    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  people        PersonOrganization[]
  pipelineItems PipelineItem[]

  @@map("organizations")
}

model PersonOrganization {
  id       String @id @default(cuid())
  personId String
  orgId    String
  role     String?

  // Relations
  person       Person       @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([personId, orgId])
  @@map("person_organizations")
}

model Relationship {
  id           String   @id @default(cuid())
  fromPersonId String
  toPersonId   String
  type         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  fromPerson Person @relation("FromRelationships", fields: [fromPersonId], references: [id], onDelete: Cascade)
  toPerson   Person @relation("ToRelationships", fields: [toPersonId], references: [id], onDelete: Cascade)

  @@unique([fromPersonId, toPersonId, type])
  @@map("relationships")
}

model Pipeline {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stages Stage[]

  @@map("pipelines")
}

model Stage {
  id         String   @id @default(cuid())
  pipelineId String
  name       String
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  pipeline     Pipeline       @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  items        PipelineItem[]
  stageHistory PipelineItemStageHistory[]
  stageRule    StageRule?

  @@unique([pipelineId, order])
  @@map("stages")
}

model PipelineItem {
  id             String   @id @default(cuid())
  title          String
  personId       String?
  organizationId String?
  ownerUserId    String?
  stageId        String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  stage        Stage         @relation(fields: [stageId], references: [id], onDelete: Cascade)
  stageHistory PipelineItemStageHistory[]
  tasks        Task[]

  @@map("pipeline_items")
}

model PipelineItemStageHistory {
  id               String    @id @default(cuid())
  pipelineItemId   String
  stageId          String
  enteredAt        DateTime  @default(now())
  leftAt           DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  pipelineItem PipelineItem @relation(fields: [pipelineItemId], references: [id], onDelete: Cascade)
  stage        Stage        @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@map("pipeline_item_stage_history")
}

model StageRule {
  id            String   @id @default(cuid())
  stageId       String
  templateTitle String
  offsetDays    Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  stage Stage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@unique([stageId])
  @@map("stage_rules")
}

model Task {
  id             String    @id @default(cuid())
  title          String
  ownerUserId    String?
  dueAt          DateTime?
  status         String    @default("pending") // pending, completed, deferred
  personId       String?
  pipelineItemId String?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  pipelineItem PipelineItem? @relation(fields: [pipelineItemId], references: [id], onDelete: SetNull)

  @@map("tasks")
}

model CustomFieldSection {
  id          String   @id @default(cuid())
  name        String
  description String?
  entityType  String   // "person" or "organization"
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  customFields CustomField[]

  @@unique([entityType, name])
  @@map("custom_field_sections")
}

model CustomField {
  id          String   @id @default(cuid())
  sectionId   String
  name        String
  label       String
  type        String   // "text", "email", "phone", "number", "date", "select", "multiselect", "textarea", "url"
  required    Boolean  @default(false)
  options     Json?    // For select/multiselect fields
  defaultValue String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  section CustomFieldSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([sectionId, name])
  @@map("custom_fields")
}
